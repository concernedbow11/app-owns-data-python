<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power BI Embedded</title>
    <!-- Load the Power BI Client Library -->
    <script src="{{ url_for('static', filename='js/powerbi.min.js') }}"></script>
    <style>
        .report-container {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
            display: none;
        }
        .page-thumbnail {
            width: 300px; /* Increased width */
            height: 200px; /* Increased height */
            border: 1px solid #ccc;
            margin: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
        }
        .grid-container {
            display: flex;
            flex-wrap: wrap;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            height: 90%;
            display: flex;
            flex-direction: column;
        }
        .close {
            color: #aaa;
            align-self: flex-end;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-report-container {
            flex: 1;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <h1>Embedded Power BI Report</h1>
    <div id="gridContainer" class="grid-container"></div>
    <div id="reportContainer" class="report-container"></div>

    <!-- The Modal -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalReportContainer" class="modal-report-container"></div>
        </div>
    </div>

    <script>
      (function() {
          // Ensure the Power BI Client Library is loaded
          if (!window["powerbi-client"]) {
              console.error("Power BI Client Library is not loaded!");
              return;
          }
  
          const reportContainer = document.getElementById("reportContainer");
          const gridContainer = document.getElementById("gridContainer");
          const modal = document.getElementById("myModal");
          const modalReportContainer = document.getElementById("modalReportContainer");
          const span = document.getElementsByClassName("close")[0];
          const embedUrl = "{{ embed_url }}";
          const embedToken = "{{ embed_token }}";
          const reportId = "{{ report_id }}";
  
          const models = window["powerbi-client"].models;
          const config = {
              type: 'report',
              tokenType: models.TokenType.Embed,
              accessToken: embedToken,
              embedUrl: embedUrl,
              id: reportId,
              settings: {
                  panes: {
                      filters: {
                          visible: false
                      },
                      pageNavigation: {
                          visible: false
                      }
                  }
              }
          };
  
          const report = window.powerbi.embed(reportContainer, config);
  
          report.on("loaded", function() {
              report.getPages().then(pages => {
                  pages.forEach(page => {
                      const placeholder = document.createElement("div");
                      placeholder.className = "page-thumbnail";
                      placeholder.innerText = page.displayName;
                      placeholder.onclick = function() {
                          modal.style.display = "block";
                          window.powerbi.embed(modalReportContainer, {
                              ...config,
                              pageName: page.name
                          });
                      };
                      gridContainer.appendChild(placeholder);
                  });
              });
          });

          // When the user clicks on <span> (x), close the modal
          span.onclick = function() {
              modal.style.display = "none";
              window.powerbi.reset(modalReportContainer);
          }

          // When the user clicks anywhere outside of the modal, close it
          window.onclick = function(event) {
              if (event.target == modal) {
                  modal.style.display = "none";
                  window.powerbi.reset(modalReportContainer);
              }
          }
      })();
    </script>
</body>
</html>
